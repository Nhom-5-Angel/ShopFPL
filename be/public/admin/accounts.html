<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý tài khoản - Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-badge.active {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-badge.locked {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div>
                <h1>Quản lý tài khoản</h1>
                <p class="welcome-text">Xin chào, <span id="admin-username"></span></p>
            </div>
            <div>
                <a href="/admin/products.html" class="btn btn-secondary" style="margin-right: 10px;">Quản lý sản phẩm</a>
                <a href="/admin/carts.html" class="btn btn-secondary" style="margin-right: 10px;">Quản lý giỏ hàng</a>
                <button onclick="handleLogout()" class="logout-button">Đăng xuất</button>
            </div>
        </header>

        <div class="dashboard-content">
            <!-- Filters -->
            <div class="filters-section">
                <div class="search-box">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Tìm kiếm theo tên, email..."
                        onkeypress="if(event.key==='Enter') handleSearch()"
                    />
                    <button onclick="handleSearch()">Tìm kiếm</button>
                </div>

                <div class="filter-group">
                    <label>Lọc theo trạng thái:</label>
                    <select id="status-filter" onchange="handleFilterChange()">
                        <option value="">Tất cả</option>
                        <option value="active">Đang hoạt động</option>
                        <option value="locked">Đã khóa</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Lọc theo role:</label>
                    <select id="role-filter" onchange="handleFilterChange()">
                        <option value="">Tất cả</option>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>

            <!-- Users Table -->
            <div class="table-container">
                <div id="loading" class="loading">Đang tải...</div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    Không có tài khoản nào
                </div>
                <table id="users-table" class="users-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên đăng nhập</th>
                            <th>Email</th>
                            <th>Số điện thoại</th>
                            <th>Role</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                    </tbody>
                </table>

                <!-- Pagination -->
                <div id="pagination" class="pagination" style="display: none;">
                    <button id="prev-btn" onclick="changePage(-1)">Trước</button>
                    <span id="page-info"></span>
                    <button id="next-btn" onclick="changePage(1)">Sau</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lock/Unlock Confirmation Modal -->
    <div id="lock-modal" class="modal-overlay" style="display: none;" onclick="closeLockModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 id="lock-modal-title">Xác nhận</h2>
            <p id="lock-modal-message"></p>
            <div class="modal-actions">
                <button onclick="handleToggleLock()" class="btn btn-warning" id="lock-confirm-btn">
                    Xác nhận
                </button>
                <button onclick="closeLockModal()" class="btn btn-secondary">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay" style="display: none;" onclick="closeDeleteModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>Xác nhận xóa</h2>
            <p>Bạn có chắc chắn muốn xóa tài khoản <strong id="delete-modal-username"></strong>?</p>
            <p class="warning-text">Hành động này không thể hoàn tác!</p>
            <div class="modal-actions">
                <button onclick="handleDeleteUser()" class="btn btn-danger" id="delete-user-btn">
                    Xóa
                </button>
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Hủy</button>
            </div>
        </div>
    </div>

    <script src="admin.js"></script>
    <script>
        // Dashboard state
        let currentPage = 1;
        let searchQuery = '';
        let statusFilter = '';
        let roleFilter = '';
        let selectedUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication
            const token = localStorage.getItem('admin_token');
            const user = localStorage.getItem('admin_user');
            
            if (!token || !user) {
                window.location.href = '/admin/login.html';
                return;
            }

            // Display admin username
            try {
                const userData = JSON.parse(user);
                document.getElementById('admin-username').textContent = userData.username;
            } catch (e) {
                console.error('Error parsing user data:', e);
            }

            // Load users
            loadUsers();
        });

        // Load users from API
        async function loadUsers() {
            const loadingDiv = document.getElementById('loading');
            const table = document.getElementById('users-table');
            const emptyState = document.getElementById('empty-state');
            const tbody = document.getElementById('users-tbody');
            const pagination = document.getElementById('pagination');

            try {
                loadingDiv.style.display = 'block';
                table.style.display = 'none';
                emptyState.style.display = 'none';
                pagination.style.display = 'none';

                const params = {
                    page: currentPage,
                    limit: 10,
                    sortBy: 'createdAt',
                    sortOrder: 'desc',
                };

                if (searchQuery) params.search = searchQuery;
                if (roleFilter) params.role = roleFilter;

                const response = await adminAPI.getAllUsers(params);

                if (response.success && response.data) {
                    let { data: users, pagination: paginationData } = response.data;

                    // Filter by status (client-side for now)
                    if (statusFilter === 'active') {
                        users = users.filter(u => !u.isLocked);
                    } else if (statusFilter === 'locked') {
                        users = users.filter(u => u.isLocked);
                    }

                    if (users.length === 0) {
                        emptyState.style.display = 'block';
                    } else {
                        table.style.display = 'table';
                        tbody.innerHTML = '';

                        users.forEach((user, index) => {
                            const row = createUserRow(user, (currentPage - 1) * 10 + index + 1);
                            tbody.appendChild(row);
                        });

                        // Update pagination
                        if (paginationData && paginationData.totalPages > 1) {
                            pagination.style.display = 'flex';
                            document.getElementById('page-info').textContent = 
                                `Trang ${paginationData.page} / ${paginationData.totalPages} (Tổng: ${paginationData.total})`;
                            document.getElementById('prev-btn').disabled = paginationData.page === 1;
                            document.getElementById('next-btn').disabled = paginationData.page >= paginationData.totalPages;
                        }
                    }
                }
            } catch (error) {
                alert(error.message || 'Lỗi khi tải danh sách tài khoản');
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Create user table row
        function createUserRow(user, index) {
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td>${index}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${user.phoneNumber || '-'}</td>
                <td>
                    <span class="role-badge ${user.role === 'admin' ? 'admin' : 'user'}">
                        ${user.role === 'admin' ? 'Admin' : 'User'}
                    </span>
                </td>
                <td>
                    <span class="status-badge ${user.isLocked ? 'locked' : 'active'}">
                        ${user.isLocked ? 'Đã khóa' : 'Đang hoạt động'}
                    </span>
                </td>
                <td>${formatDate(user.createdAt)}</td>
                <td>
                    <div class="action-buttons">
                        <button onclick="openLockModal('${user._id}', '${user.username}', ${user.isLocked})" 
                                class="btn ${user.isLocked ? 'btn-primary' : 'btn-warning'}">
                            ${user.isLocked ? 'Mở khóa' : 'Khóa'}
                        </button>
                        <button onclick="openDeleteModal('${user._id}', '${user.username}')" 
                                class="btn btn-danger">Xóa</button>
                    </div>
                </td>
            `;
            
            return tr;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
            });
        }

        // Search handler
        function handleSearch() {
            searchQuery = document.getElementById('search-input').value.trim();
            currentPage = 1;
            loadUsers();
        }

        // Filter change handler
        function handleFilterChange() {
            statusFilter = document.getElementById('status-filter').value;
            roleFilter = document.getElementById('role-filter').value;
            currentPage = 1;
            loadUsers();
        }

        // Pagination
        function changePage(delta) {
            currentPage += delta;
            loadUsers();
        }

        // Lock Modal
        function openLockModal(userId, username, isLocked) {
            selectedUser = { _id: userId, username, isLocked };
            document.getElementById('lock-modal-title').textContent = isLocked ? 'Mở khóa tài khoản' : 'Khóa tài khoản';
            document.getElementById('lock-modal-message').textContent = 
                isLocked 
                    ? `Bạn có chắc chắn muốn mở khóa tài khoản "${username}"?`
                    : `Bạn có chắc chắn muốn khóa tài khoản "${username}"?`;
            document.getElementById('lock-confirm-btn').textContent = isLocked ? 'Mở khóa' : 'Khóa';
            document.getElementById('lock-modal').style.display = 'flex';
        }

        function closeLockModal() {
            document.getElementById('lock-modal').style.display = 'none';
            selectedUser = null;
        }

        async function handleToggleLock() {
            if (!selectedUser) return;

            const btn = document.getElementById('lock-confirm-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Đang xử lý...';

            try {
                const response = await adminAPI.toggleUserLock(selectedUser._id, !selectedUser.isLocked);
                if (response.success) {
                    alert(response.message || 'Thao tác thành công!');
                    closeLockModal();
                    loadUsers();
                }
            } catch (error) {
                alert(error.message || 'Lỗi khi thực hiện thao tác');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Delete Modal
        function openDeleteModal(userId, username) {
            selectedUser = { _id: userId, username };
            document.getElementById('delete-modal-username').textContent = username;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            selectedUser = null;
        }

        async function handleDeleteUser() {
            if (!selectedUser) return;

            const btn = document.getElementById('delete-user-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Đang xóa...';

            try {
                const response = await adminAPI.deleteUser(selectedUser._id);
                if (response.success) {
                    alert('Xóa tài khoản thành công!');
                    closeDeleteModal();
                    loadUsers();
                }
            } catch (error) {
                alert(error.message || 'Lỗi khi xóa tài khoản');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    </script>
</body>
</html>
